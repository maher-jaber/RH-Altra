server {
  listen 80;
  server_name _;

  # -------- FRONT (Angular static) --------
  root /var/www/front;
  index index.html;

  location / {
    try_files $uri $uri/ /index.html;
  }

  # -------- API (Symfony) --------
  # /api (sans slash) => /api/
  location = /api {
    return 301 /api/;
  }

  # Pour toute requête /api/..., on réécrit vers le front-controller
  # en conservant le PATH_INFO = /api/...
  location /api/ {
    try_files $uri $uri/ @symfony_api;
  }

  location @symfony_api {
    rewrite ^/api(/.*)$ /index.php/api$1 last;
  }

  # Le front-controller Symfony (interne uniquement)
  location ~ ^/index\.php(/|$) {
    internal;

    fastcgi_split_path_info ^(.+\.php)(/.*)$;
    include fastcgi_params;

    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_param REQUEST_URI $request_uri;

    # IMPORTANT: chemin côté NGINX (volume monté), pas côté container API
        # Chemin côté container API (php-fpm)
    fastcgi_param SCRIPT_FILENAME /app/public$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT /app/public;

    # Symfony behind reverse-proxy
    fastcgi_param HTTPS $https if_not_empty;

    fastcgi_pass api:9000;
    fastcgi_read_timeout 120s;
  }

  location ~ \.php$ {
    return 404;
  }

  # -------- Mercure (optional) --------
  location /.well-known/mercure {
    proxy_pass http://mercure/.well-known/mercure;
    proxy_read_timeout 24h;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options SAMEORIGIN;
  add_header Referrer-Policy strict-origin-when-cross-origin;
}
